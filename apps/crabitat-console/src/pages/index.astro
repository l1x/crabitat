---
import Layout from '../layouts/Layout.astro';
import Sidebar from '../components/Sidebar.astro';
import ContentHeader from '../components/ContentHeader.astro';
import MetricGrid from '../components/MetricGrid.astro';
import ColonyGrid from '../components/ColonyGrid.astro';
import CrabGrid from '../components/CrabGrid.astro';
import MissionTable from '../components/MissionTable.astro';
import TaskTable from '../components/TaskTable.astro';
import RunTable from '../components/RunTable.astro';
import NewMissionModal from '../components/NewMissionModal.astro';
import IssueQueue from '../components/IssueQueue.astro';
import type { StatusSnapshot } from '../lib/types';

const CONTROL_PLANE_URL = import.meta.env.CONTROL_PLANE_URL || 'http://127.0.0.1:8800';

let snapshot: StatusSnapshot | null = null;
let error: string | null = null;

try {
  const res = await fetch(`${CONTROL_PLANE_URL}/v1/status`);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  snapshot = await res.json();
} catch (err) {
  error = err instanceof Error ? err.message : String(err);
}

const activeTasks = snapshot?.tasks.filter(
  (t) => t.status === 'running' || t.status === 'assigned' || t.status === 'queued',
) ?? [];
---

<Layout title="Crabitat Colony Console">
  <Sidebar
    colonyCount={snapshot?.colonies.length ?? 0}
    crabCount={snapshot?.crabs.length ?? 0}
    missionCount={snapshot?.missions.length ?? 0}
    taskCount={snapshot?.tasks.length ?? 0}
    runCount={snapshot?.runs.length ?? 0}
    hasActiveTasks={activeTasks.length > 0}
    controlPlaneUrl={CONTROL_PLANE_URL}
    isOnline={!error}
  />

  <div class="content">
    <ContentHeader title="Overview" />

    {error ? (
      <div class="section">
        <div class="data-panel">
          <div class="data-panel-body">
            <div class="empty-state">
              <div class="empty-state-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
              </div>
              <div class="empty-state-title">Control-plane unreachable</div>
              <p class="empty-state-desc">Unable to reach {CONTROL_PLANE_URL}: {error}</p>
              <button class="btn btn--primary" onclick="location.reload()">Retry</button>
            </div>
          </div>
        </div>
      </div>
    ) : snapshot ? (
      <>
        <!-- Overview -->
        <div class="section" data-section="overview">
          <MetricGrid summary={snapshot.summary} />

          <div class="data-panel">
            <div class="data-panel-header">
              <span class="data-panel-title">Colonies</span>
            </div>
            <div class="data-panel-body">
              {snapshot.colonies.length === 0 ? (
                <div class="empty-state">
                  <div class="empty-state-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                  </div>
                  <div class="empty-state-title">No colonies yet</div>
                  <p class="empty-state-desc">Create your first colony with POST /v1/colonies.</p>
                </div>
              ) : (
                <div class="card-grid" id="overview-colony-container">
                  {snapshot.colonies.map((colony) => (
                    <div class="card" data-id={colony.colony_id}>
                      <div class="card-title">{colony.name}</div>
                      <div class="card-meta">{colony.colony_id.slice(0, 8)} &middot; {colony.description || 'No description'}</div>
                      <div class="card-meta">{snapshot.crabs.filter((c) => c.colony_id === colony.colony_id).length} crabs</div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>

          <div class="data-panel">
            <div class="data-panel-header">
              <span class="data-panel-title">Crab Roster</span>
            </div>
            <div class="data-panel-body">
              {snapshot.crabs.length === 0 ? (
                <div class="empty-state">
                  <div class="empty-state-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                  </div>
                  <div class="empty-state-title">No crabs registered</div>
                  <p class="empty-state-desc">Use scripts/spawn-crab.sh to add a crab agent.</p>
                </div>
              ) : (
                <div class="card-grid" id="overview-crab-container">
                  {snapshot.crabs.map((crab) => (
                    <div class="card" data-id={crab.crab_id} data-state={crab.state}>
                      <div class="card-title">
                        {crab.name}
                        <span class={`badge badge--${crab.state}`}>{crab.state}</span>
                      </div>
                      <div class="card-meta">{crab.role} &middot; {crab.crab_id.slice(0, 12)}</div>
                      {crab.current_task_id && (
                        <div class="card-detail">Task: <code>{crab.current_task_id.slice(0, 8)}</code></div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>

        <!-- Colonies detail -->
        <div class="section" data-section="colonies" hidden>
          <ColonyGrid colonies={snapshot.colonies} crabs={snapshot.crabs} missions={snapshot.missions} />
        </div>

        <!-- Crabs detail -->
        <div class="section" data-section="crabs" hidden>
          <CrabGrid crabs={snapshot.crabs} />
        </div>

        <!-- Missions -->
        <div class="section" data-section="missions" hidden>
          <MissionTable missions={snapshot.missions} />
        </div>

        <!-- Tasks -->
        <div class="section" data-section="tasks" hidden>
          <TaskTable tasks={snapshot.tasks} />
        </div>

        <!-- Runs -->
        <div class="section" data-section="runs" hidden>
          <RunTable runs={snapshot.runs} />
        </div>

        <!-- Queue -->
        <div class="section" data-section="queue" hidden>
          <IssueQueue colonies={snapshot.colonies} />
        </div>

        <NewMissionModal colonies={snapshot.colonies} />
      </>
    ) : null}
  </div>
</Layout>

<script>
  import '../scripts/nav';
  import '../scripts/search';
  import '../scripts/modal';
  import '../scripts/ws-client';
  import '../scripts/queue';
</script>
